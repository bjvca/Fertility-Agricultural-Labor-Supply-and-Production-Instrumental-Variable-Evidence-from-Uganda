clear 
use "/home/bjvca/data/data/UGANDA/UNHS/UNHS_2005/UNHS_III_AGRIC_DATA/asec4a.dta"
rename a4aq5b cropcode
sort hh cropcode

gen areafarmer=a4aq3 * a4aq6/100


collapse (sum) areafarmer, by(hh cropcode)
save plots, replace


use "/home/bjvca/data/data/UGANDA/UNHS/UNHS_2005/UNHS_III_AGRIC_DATA/asec7a.dta"
rename a7aq2b cropcode
sort hh cropcode
keep if cropcode==130
* we need conversion factors here
rename a7aq3a untcd
sort untcd
save sp, replace


use   "/home/bjvca/data/data/fertility and ag productivity/datasets/conversionfactors.dta"

keep if descript==111
sort untcd
merge  untcd using  sp
replace qkg_uca=100 if untcd==10


gen totkg = a7aq3b *qkg_uca
collapse (sum) totkg, by(hh cropcode)
sort hh cropcode
merge hh cropcode using plots


gen yield=totkg/areafarmer
*regress yield area 

drop _merge
sort hh
save yields, replace
use yields


 sort hh
 merge hh using firststage
 keep if _merge==3
 

*maize
tab region, gen(regd)

regress yield  dif_size femhead_hh substrat momedu_hh_dum*  health pschool memdead regd*  if cropcode==130 & yield<4000, robust
estimates store m1
ivreg2  yield  femhead_hh substrat momedu_hh_dum*  health pschool memdead  regd* (dif_size=oldestgirl )  if cropcode==130 & yield<4000, robust

ivreg2  yield  femhead_hh substrat momedu_hh_dum*  health pschool memdead  regd* (dif_size=secondoldestgirl )  if if size>1 & cropcode==130 & yield<4000, robust
ivreg2  yield  femhead_hh substrat momedu_hh_dum*  health pschool memdead  regd* (dif_size=percentfmales )  if cropcode==130 & yield<4000, robust
ivreg2  yield  femhead_hh substrat momedu_hh_dum*  health pschool memdead  regd* (dif_size=percentfmales oldestgirl )  if cropcode==130 & yield<4000, liml robust

*beans
regress yield  dif_size femhead_hh substrat momedu_hh_dum*  health pschool memdead regd*  if cropcode==210 & yield<4000, robust
estimates store m1
ivreg2  yield  femhead_hh substrat momedu_hh_dum*  health pschool memdead  regd* (dif_size=oldestgirl )  if cropcode==210 & yield<4000, robust

ivreg2  yield  femhead_hh substrat momedu_hh_dum*  health pschool memdead  regd* (dif_size=secondoldestgirl )  if if size>1 & cropcode==210 & yield<4000, robust
ivreg2  yield  femhead_hh substrat momedu_hh_dum*  health pschool memdead  regd* (dif_size=percentfmales )  if cropcode==210 & yield<4000, robust
ivreg2  yield  femhead_hh substrat momedu_hh_dum*  health pschool memdead  regd* (dif_size=percentfmales oldestgirl )  if cropcode==210 & yield<4000, liml robust


*s potatoes
regress yield  dif_size femhead_hh substrat momedu_hh_dum*  health pschool memdead regd*  if cropcode==620 & yield<4000, robust
estimates store m1
ivreg2  yield  femhead_hh substrat momedu_hh_dum*  health pschool memdead  regd* (dif_size=oldestgirl )  if cropcode==620 & yield<4000, robust

ivreg2  yield  femhead_hh substrat momedu_hh_dum*  health pschool memdead  regd* (dif_size=secondoldestgirl )  if if size>1 & cropcode==620 & yield<4000, robust
ivreg2  yield  femhead_hh substrat momedu_hh_dum*  health pschool memdead  regd* (dif_size=percentfmales )  if cropcode==620 & yield<4000, robust
ivreg2  yield  femhead_hh substrat momedu_hh_dum*  health pschool memdead  regd* (dif_size=percentfmales oldestgirl )  if cropcode==620 & yield<4000, liml robust


*cassava
regress yield  dif_size femhead_hh substrat momedu_hh_dum*  health pschool memdead regd*  if cropcode==630 & yield<4000, robust
estimates store m1
ivreg2  yield  femhead_hh substrat momedu_hh_dum*  health pschool memdead  regd* (dif_size=oldestgirl )  if cropcode==630 & yield<4000, robust

ivreg2  yield  femhead_hh substrat momedu_hh_dum*  health pschool memdead  regd* (dif_size=secondoldestgirl )  if if size>1 & cropcode==630 & yield<4000, robust
ivreg2  yield  femhead_hh substrat momedu_hh_dum*  health pschool memdead  regd* (dif_size=percentfmales )  if cropcode==630 & yield<4000, robust
ivreg2  yield  femhead_hh substrat momedu_hh_dum*  health pschool memdead  regd* (dif_size=percentfmales oldestgirl )  if cropcode==630 & yield<4000, liml robust



*matooke
regress yield  dif_size femhead_hh substrat momedu_hh_dum*  health pschool memdead regd*  if cropcode==741 & yield<6000, robust
estimates store m1
ivreg2  yield  femhead_hh substrat momedu_hh_dum*  health pschool memdead  regd* (dif_size=oldestgirl )  if cropcode==741 & yield<6000, robust

ivreg2  yield  femhead_hh substrat momedu_hh_dum*  health pschool memdead  regd* (dif_size=secondoldestgirl )  if  size>1 & cropcode==741 & yield<4000, robust
ivreg2  yield  femhead_hh substrat momedu_hh_dum*  health pschool memdead  regd* (dif_size=percentfmales )  if cropcode==741 & yield<4000, robust
ivreg2  yield  femhead_hh substrat momedu_hh_dum*  health pschool memdead  regd* (dif_size=percentfmales oldestgirl )  if cropcode==741 & yield<6000, liml robust



*aggregate

gen totval=totkg*293 if cropcode==130
replace totval=totkg*549 if cropcode==210
replace totval=totkg*185 if cropcode==620
replace totval=totkg*168 if cropcode==630
replace totval=totkg*215 if cropcode==741
drop if totval==.

collapse (sum) totval  areafarmer, by(hh)


gen yield=totval/areafarmer
replace yield=yield/1000
sort hh
 merge hh using firststage
 keep if _merge==3


 tab region, gen(dreg)
 
 gen prod_cap=totval/hhsize
  regress  totval  size   agefirstborn femhead_hh substrat dreg* if prod_cap < 180000  , robust 
  estimates store m1
 ivreg2  totval    agefirstborn femhead_hh substrat dreg* (size=oldestgirl) if prod_cap < 190000  , robust 
 estimates store m2
 
 regress yield size substrat agefirstborn femhead_hh   dreg* if prod_cap < 190000   , robust 
 estimates store m3
ivreg2  yield   agefirstborn femhead_hh substrat   dreg* (size = oldestgirl  )if prod_cap < 190000   , robust 
 estimates store m4 
 

 
 regress  prod_cap  size   agefirstborn femhead_hh substrat dreg* if prod_cap < 190000  , robust 
 estimates store m5
  ivreg2  prod_cap    agefirstborn femhead_hh substrat dreg* (size=oldestgirl) if prod_cap < 190000  , robust 
 estimates store m6
 
estout m1 m2 m3 m4 m5 m6, cells(b(star fmt(3)) se(par fmt(3)))starlevels(+ 0.10 * 0.05 ** 0.01)  stats(r2 N) style(tex) drop(regd*)

